from flask import Blueprint, jsonify, request
from db import get_db_connection
import logging

get_memos_bp = Blueprint('get_memos_bp', __name__)

@get_memos_bp.route('/get-memos', methods=['GET'])
def get_memos():
    try:
        conn = get_db_connection()
        cursor = conn.cursor()

        query = """
            SELECT
                memo_id,
                processing_status,
                user_approval,
                template_type,
                client_name_input,
                updated_at
            FROM cledev.memos
            ORDER BY updated_at DESC;
        """

        logging.info("Executing memo fetch SQL:\n%s", query)

        cursor.execute(query)
        rows = cursor.fetchall()

        # Get column names for mapping
        colnames = [desc[0] for desc in cursor.description]

        memos = []
        for row in rows:
            memo = dict(zip(colnames, row))
            memos.append({
                "memo_id": str(memo["memo_id"]),
                "process_status": memo["processing_status"],
                "user_status": "completed" if memo["user_approval"] else "draft",
                "template_type": memo["template_type"],
                "client_name": memo["client_name_input"],
                "last_modified_date_time": memo["updated_at"].isoformat().replace("+00:00", "Z")
            })

        cursor.close()
        conn.close()

        return jsonify({"memos": memos}), 200

    except Exception as e:
        logging.error(f"Error fetching memos: {e}")
        return jsonify({
            "status": "error",
            "message": "Failed to fetch memos"
        }), 500
