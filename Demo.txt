from flask import Flask, request, jsonify
from werkzeug.exceptions import Unauthorized, BadRequest
import uuid

app = Flask(__name__)

@app.route('/create-new-memo', methods=['POST'])
def create_new_memo():
    try:
        data = request.get_json()

        if not data:
            raise BadRequest("Missing JSON data")

        # Authorization (dummy logic)
        auth_header = request.headers.get('Authorization')
        if not auth_header or auth_header != "Bearer your-token":
            raise Unauthorized("Unauthorized: invalid or missing token")

        # Common required fields
        required_common_keys = ['user_id', 'template_type', 'client_name']
        for key in required_common_keys:
            if key not in data:
                return validation_error([{
                    "loc": [key],
                    "msg": f"Missing required field: {key}",
                    "type": "value_error.missing"
                }])

        template_type = data["template_type"]

        if template_type == "client_memo":
            required_fields = ["memo_title", "meeting_details", "attendees"]
            for key in required_fields:
                if key not in data:
                    return validation_error([{
                        "loc": [key],
                        "msg": f"Missing required field in client_memo: {key}",
                        "type": "value_error.missing"
                    }])

            meeting = data["meeting_details"]
            meeting_required = ["date", "time", "in_person", "purpose", "key_areas_for_discussion"]
            for key in meeting_required:
                if key not in meeting:
                    return validation_error([{
                        "loc": ["meeting_details", key],
                        "msg": f"Missing field in meeting_details: {key}",
                        "type": "value_error.missing"
                    }])
            # location is optional â€” no check required

            # Attendees validation
            if not isinstance(data["attendees"], list) or len(data["attendees"]) == 0:
                return validation_error([{
                    "loc": ["attendees"],
                    "msg": "attendees must be a non-empty list",
                    "type": "value_error"
                }])

            for idx, attendee in enumerate(data["attendees"]):
                for role in ["client", "nt"]:
                    if role not in attendee:
                        return validation_error([{
                            "loc": [f"attendees[{idx}]", role],
                            "msg": f"Missing required role: {role}",
                            "type": "value_error.missing"
                        }])
                # consultant is optional

        elif template_type == "client_template":
            required_fields = ["key_areas_for_discussion", "key_client_contacts"]
            if not all(k in data for k in required_fields):
                return validation_error([{
                    "loc": ["client_template"],
                    "msg": "Missing one or more required fields",
                    "type": "value_error.structure"
                }])
        else:
            return validation_error([{
                "loc": ["template_type"],
                "msg": f"Invalid template_type: {template_type}",
                "type": "value_error"
            }])

        # Return success response
        return jsonify({
            "template_id": str(uuid.uuid4()),
            "client_name": data["client_name"],
            "status": "processing"
        }), 200

    except Unauthorized as e:
        return jsonify({
            "details": None,
            "errors": [{
                "code": "Unauthorized",
                "message": str(e)
            }]
        }), 401

    except BadRequest as e:
        return validation_error([{
            "loc": ["request"],
            "msg": str(e),
            "type": "value_error.request"
        }])

    except Exception:
        return jsonify({
            "detail": {
                "code": "Internal Server Error",
                "message": "Something went wrong while internal memo creation, please try again."
            }
        }), 500

def validation_error(errors):
    return jsonify({"detail": errors}), 422

if __name__ == '__main__':
    app.run(debug=True)
