from src.agents.external_info_agent.bing_search_plugin import BingSearchPlugin
from src.variables import BING_SEARCH_RETRY_THRESHOLD
import json


def run_bing_agent(content: str, instructions: str):
    retry = True
    run_count = 0
    messages = {}

    while retry and run_count < BING_SEARCH_RETRY_THRESHOLD:
        bingFoundryProjectCompanyNews = BingSearchPlugin()
        bingFoundryProjectCompanyNews.auth()

        client = bingFoundryProjectCompanyNews.client
        agent = bingFoundryProjectCompanyNews.createAgent(
            client=client, instructions=instructions
        )
        thread = bingFoundryProjectCompanyNews.createThread(
            client=client, agent=agent, content=content
        )
        messages, retry = bingFoundryProjectCompanyNews.createRun(
            client=client, agent=agent, thread=thread
        )

        bingFoundryProjectCompanyNews.deleteAgent(client=client, agent=agent)

        # If no citations are found, force retry
        if not messages.get("citations"):
            retry = True

        try:
            # Validate that the output text is valid JSON
            json_output_validation = json.loads(messages["text"])
        except Exception:
            retry = True

        run_count += 1

    return messages
