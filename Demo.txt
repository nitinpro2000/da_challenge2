import asyncpg
import asyncio
import csv

async def fetch_and_save_to_csv():
    # Connect to your PostgreSQL database
    conn = await asyncpg.connect(
        user='your_user',
        password='your_password',
        database='your_database',
        host='localhost',
        port=5432
    )

    try:
        # Run the SELECT query
        query = 'SELECT id, name, email FROM users;'  # Replace with your actual query
        records = await conn.fetch(query)

        if not records:
            print("No data found.")
            return

        # Get column names
        column_names = records[0].keys()

        # Save to CSV
        with open('output.csv', mode='w', newline='', encoding='utf-8') as csvfile:
            writer = csv.writer(csvfile)
            writer.writerow(column_names)  # Write header
            for record in records:
                writer.writerow(record.values())  # Write data rows

        print("Data written to output.csv")

    finally:
        await conn.close()

# Run the async function
asyncio.run(fetch_and_save_to_csv())
